<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Beebro</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #1a1a1a; height: 100vh; overflow: hidden; }
    
    .header { background: #fff; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; height: 56px; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo { font-size: 22px; font-weight: bold; color: #007AFF; }
    .burger { display: none; background: none; border: none; padding: 8px; cursor: pointer; }
    .burger svg { width: 24px; height: 24px; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    
    .btn { padding: 6px 12px; border-radius: 6px; border: 1px solid #d0d0d0; background: #fff; color: #333; cursor: pointer; font-size: 14px; white-space: nowrap; }
    .btn:hover { background: #f0f0f0; }
    .btn-primary { background: #007AFF; border-color: #007AFF; color: #fff; }
    .btn-primary:hover { background: #0066e0; }
    .btn-danger { background: #dc3545; border-color: #dc3545; color: #fff; }
    .btn-small { padding: 4px 8px; font-size: 12px; }
    
    .login-container { display: flex; justify-content: center; align-items: center; height: calc(100vh - 56px); padding: 16px; }
    .login-box { background: #fff; padding: 32px; border-radius: 12px; border: 1px solid #e0e0e0; width: 100%; max-width: 320px; }
    .login-box h2 { margin-bottom: 24px; text-align: center; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; color: #666; font-size: 14px; }
    .form-group input { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #d0d0d0; font-size: 16px; }
    
    /* Desktop tabs */
    .tabs { display: flex; background: #fff; border-bottom: 1px solid #e0e0e0; }
    .tab { padding: 12px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; white-space: nowrap; }
    .tab:hover { color: #333; }
    .tab.active { color: #007AFF; border-bottom-color: #007AFF; }
    
    /* Mobile menu */
    .mobile-menu { display: none; position: fixed; top: 56px; left: 0; right: 0; bottom: 0; background: #fff; z-index: 100; flex-direction: column; }
    .mobile-menu.open { display: flex; }
    .mobile-menu-item { padding: 16px 20px; border-bottom: 1px solid #e0e0e0; font-size: 16px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 12px; }
    .mobile-menu-item:hover { background: #f5f5f5; }
    .mobile-menu-item.active { color: #007AFF; background: #e8f4fc; }
    .mobile-menu-item svg { width: 20px; height: 20px; }
    
    .main-container { display: flex; height: calc(100vh - 110px); }
    
    /* Sessions panel - desktop */
    .sessions-panel { width: 220px; background: #fff; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; flex-shrink: 0; }
    .sessions-header { padding: 12px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .sessions-header h3 { font-size: 13px; color: #666; }
    .sessions-list { flex: 1; overflow-y: auto; }
    .session-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; cursor: pointer; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0; }
    .session-item:hover { background: #f5f5f5; }
    .session-item.active { background: #e8f4fc; color: #007AFF; border-left: 3px solid #007AFF; }
    .session-close { opacity: 0; background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 0 4px; }
    .session-item:hover .session-close { opacity: 1; }
    .no-sessions { padding: 20px; text-align: center; color: #999; font-size: 13px; }
    
    /* Mobile sessions - horizontal scroll */
    .sessions-bar { display: none; background: #fff; border-bottom: 1px solid #e0e0e0; padding: 8px; }
    .sessions-bar-inner { display: flex; gap: 8px; overflow-x: auto; align-items: center; }
    .sessions-bar-inner::-webkit-scrollbar { display: none; }
    .session-chip { padding: 6px 12px; background: #f0f0f0; border-radius: 16px; font-size: 13px; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .session-chip.active { background: #007AFF; color: #fff; }
    .session-chip .close { font-size: 14px; opacity: 0.7; }
    .session-chip:hover .close { opacity: 1; }
    .add-session-btn { padding: 6px 12px; background: #007AFF; color: #fff; border: none; border-radius: 16px; font-size: 13px; cursor: pointer; white-space: nowrap; }
    
    .terminal-wrapper { flex: 1; display: flex; flex-direction: column; background: #1e1e1e; min-width: 0; }
    .terminal-container { flex: 1; overflow: hidden; }
    .status-bar { padding: 6px 12px; background: #fff; border-top: 1px solid #e0e0e0; font-size: 12px; color: #666; display: flex; align-items: center; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #999; margin-right: 8px; }
    .status-dot.connected { background: #28a745; }
    
    /* Files */
    .ftp-info { background: #e8f4fc; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #b8daff; font-size: 14px; }
    .ftp-info small { color: #666; }
    .web-link { color: #0066cc; text-decoration: none; }
    .web-link:hover { text-decoration: underline; }
    .file-manager-frame { width: 100%; height: calc(100% - 70px); border: none; border-radius: 8px; background: #fff; }
    .file-manager-frame { width: 100%; height: calc(100% - 80px); border: 1px solid #e0e0e0; border-radius: 8px; background: #fff; }
    
    .file-manager { display: flex; flex-direction: column; height: calc(100% - 60px); }
    .file-toolbar { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff; border-radius: 8px 8px 0 0; border: 1px solid #e0e0e0; border-bottom: none; }
    .current-path { flex: 1; font-family: monospace; padding: 6px 12px; background: #f5f5f5; border-radius: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .toolbar-actions { display: flex; gap: 5px; }
    .file-list { flex: 1; overflow-y: auto; background: #fff; border: 1px solid #e0e0e0; border-radius: 0 0 8px 8px; }
    .file-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.15s; }
    .file-item:hover { background: #f8f9fa; }
    .file-item .icon { width: 24px; margin-right: 10px; font-size: 18px; }
    .file-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-item .size { color: #888; font-size: 13px; margin-right: 15px; min-width: 60px; text-align: right; }
    .file-item .actions { opacity: 0; transition: opacity 0.15s; display: flex; gap: 4px; }
    .file-item:hover .actions { opacity: 1; }
    .file-item .actions button { padding: 2px 8px; font-size: 12px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; }
    .file-item .actions button:hover { background: #e0e0e0; }
    .file-editor { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #fff; display: flex; flex-direction: column; z-index: 100; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; }
    .editor-header span { font-family: monospace; font-size: 14px; }
    #editorContent { flex: 1; border: none; outline: none; resize: none; padding: 15px; font-family: monospace; font-size: 14px; line-height: 1.5; }
    .btn-sm { padding: 5px 10px; font-size: 13px; }

    .files-panel { height: calc(100vh - 110px); overflow-y: auto; padding: 16px; }
    .files-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; gap: 12px; flex-wrap: wrap; }
    .files-path { font-family: monospace; background: #fff; padding: 8px 12px; border-radius: 6px; border: 1px solid #e0e0e0; font-size: 13px; word-break: break-all; flex: 1; }
    .files-buttons { display: flex; gap: 8px; }
    .files-list { display: flex; flex-direction: column; gap: 8px; }
    .file-item { display: flex; align-items: center; padding: 12px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; cursor: pointer; gap: 12px; }
    .file-item:hover { border-color: #007AFF; }
    .file-icon { font-size: 20px; }
    .file-info { flex: 1; min-width: 0; }
    .file-name { font-weight: 500; word-break: break-all; }
    .file-meta { font-size: 12px; color: #999; }
    
    /* Admin */
    .admin-panel { display: flex; height: calc(100vh - 110px); }
    .admin-nav { width: 200px; background: #fff; border-right: 1px solid #e0e0e0; padding: 12px 0; }
    .admin-nav-item { display: flex; align-items: center; padding: 10px 16px; cursor: pointer; color: #666; font-size: 14px; gap: 10px; }
    .admin-nav-item:hover { background: #f5f5f5; }
    .admin-nav-item.active { background: #e8f4fc; color: #007AFF; border-left: 3px solid #007AFF; }
    .admin-nav-item svg { width: 18px; height: 18px; }
    .admin-content { flex: 1; overflow-y: auto; padding: 16px; }
    .admin-content h2 { margin-bottom: 16px; font-size: 20px; }
    
    .server-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 14px; border-radius: 8px; border: 1px solid #e0e0e0; }
    .stat-label { font-size: 12px; color: #666; margin-bottom: 4px; }
    .stat-value { font-size: 22px; font-weight: 600; }
    .stat-bar { height: 6px; background: #e0e0e0; border-radius: 3px; margin-top: 8px; }
    .stat-bar-fill { height: 100%; background: #007AFF; border-radius: 3px; }
    
    .containers-list { background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; }
    .container-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #e0e0e0; gap: 12px; }
    .container-item:last-child { border-bottom: none; }
    .container-status { width: 10px; height: 10px; border-radius: 50%; }
    .container-status.running { background: #28a745; }
    .container-status.stopped { background: #dc3545; }
    .container-info { flex: 1; }
    .container-name { font-weight: 500; }
    .container-ip { font-size: 12px; color: #666; }
    .container-size { font-size: 12px; color: #888; }
    
    .users-form { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .users-form input { padding: 8px 12px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px; }
    .users-form label { display: flex; align-items: center; gap: 6px; font-size: 14px; }
    .users-table-wrap { overflow-x: auto; }
    .users-table { width: 100%; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; border-collapse: collapse; min-width: 500px; }
    .users-table th, .users-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
    .users-table th { background: #f9f9f9; font-weight: 500; color: #666; font-size: 13px; }
    .users-table tr:last-child td { border-bottom: none; }
    .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; }
    .badge-admin { background: #fff3cd; color: #856404; }
    .badge-user { background: #d4edda; color: #155724; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 16px; }
    .modal { background: #fff; padding: 20px; border-radius: 12px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
    .modal h3 { margin-bottom: 16px; }
    .modal-session { padding: 8px 12px; background: #f5f5f5; border-radius: 6px; margin-bottom: 8px; font-family: monospace; font-size: 13px; }
    .modal-form-group { margin-bottom: 16px; }
    .modal-form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; }
    .modal-input { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    .modal-input:focus { outline: none; border-color: #0d8aee; box-shadow: 0 0 0 3px rgba(13,138,238,0.1); }
    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .checkbox-label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee; }
    
    .hidden { display: none !important; }
    
    /* Mobile */
    @media (max-width: 768px) {
      .burger { display: block; }
      .tabs { display: none; }
      .user-info span { display: none; }
      
      .sessions-panel { display: none; }
      .sessions-bar { display: block; }
      
      .main-container { flex-direction: column; height: calc(100vh - 56px); }
      #terminalTab { height: calc(100vh - 56px); display: flex; flex-direction: column; }
      .terminal-wrapper { flex: 1; min-height: 0; }
      
      .files-panel { height: calc(100vh - 56px); padding: 12px; }
      
      .admin-panel { flex-direction: column; height: calc(100vh - 56px); }
      .admin-nav { width: 100%; border-right: none; border-bottom: 1px solid #e0e0e0; display: flex; overflow-x: auto; padding: 0; }
      .admin-nav-item { padding: 12px 16px; border-left: none !important; white-space: nowrap; flex-shrink: 0; }
      .admin-nav-item.active { border-left: none; border-bottom: 2px solid #007AFF; background: transparent; }
      .admin-content { flex: 1; overflow-y: auto; }
      
      .users-form { flex-direction: column; }
      .users-form input { width: 100%; }
      .users-form .btn-primary { width: 100%; }
      .server-stats { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 480px) {
      .server-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <button class="burger" onclick="toggleMenu()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="logo">Beebro</div>
    </div>
    <div class="user-info" id="userInfo"></div>
  </div>

  <!-- Mobile menu -->
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-item active" data-tab="terminal" onclick="switchTab('terminal');toggleMenu()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 15l4-4-4-4M13 15h4"/></svg>
      –¢–µ—Ä–º–∏–Ω–∞–ª
    </div>
    <div class="mobile-menu-item" data-tab="files" onclick="switchTab('files');toggleMenu()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
      –§–∞–π–ª—ã
    </div>
    <div class="mobile-menu-item admin-only" data-tab="admin" onclick="switchTab('admin');toggleMenu()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 112.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 112.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      –ê–¥–º–∏–Ω
    </div>
  </div>

  <div id="loginView" class="login-container">
    <div class="login-box">
      <h2>–í—Ö–æ–¥</h2>
      <div class="form-group"><label>–õ–æ–≥–∏–Ω</label><input type="text" id="loginUsername"></div>
      <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="loginPassword"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:8px" onclick="login()">–í–æ–π—Ç–∏</button>
    </div>
  </div>

  <div id="appView" class="hidden">
    <!-- Desktop tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="terminal" onclick="switchTab('terminal')">–¢–µ—Ä–º–∏–Ω–∞–ª</div>
      <div class="tab" data-tab="files" onclick="switchTab('files')">–§–∞–π–ª—ã</div>
      <div class="tab admin-only" data-tab="admin" onclick="switchTab('admin')">–ê–¥–º–∏–Ω</div>
    </div>

    <!-- Terminal Tab -->
    <div id="terminalTab" class="main-container">
      <!-- Desktop sessions panel -->
      <div class="sessions-panel">
        <div class="sessions-header">
          <h3>–°–µ—Å—Å–∏–∏</h3>
          <button class="btn btn-small btn-primary" onclick="createSession()">+ –ù–æ–≤–∞—è</button>
        </div>
        <div class="sessions-list" id="sessionsList"></div>
      </div>
      
      <!-- Mobile sessions bar -->
      <div class="sessions-bar">
        <div class="sessions-bar-inner" id="sessionsBar"></div>
      </div>
      
      <div class="terminal-wrapper">
        <div id="terminalContainer" class="terminal-container" onclick="terminal && terminal.focus()"></div>
        <div class="status-bar">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
        </div>
      </div>
    </div>

    <!-- Files Tab -->
    <div id="filesTab" class="files-panel hidden">
      <div class="ftp-info" id="webInfo">
        <strong>üåê Web:</strong> <a id="webLink" href="#" target="_blank" class="web-link"></a>
      </div>
      <div class="ftp-info">
        <strong>üìÇ FTP:</strong> ftp://console.beebro.com | <strong>üí°</strong> –õ–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∫–∞–∫ –≤ Beebro
      </div>
      <div class="file-manager">
        <div class="file-toolbar">
          <button onclick="navigateUp()" class="btn btn-sm">‚¨ÜÔ∏è –í–≤–µ—Ä—Ö</button>
          <span id="currentPath" class="current-path">/root</span>
          <div class="toolbar-actions">
            <button onclick="createFolder()" class="btn btn-sm">üìÅ –ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button>
            <button onclick="createFile()" class="btn btn-sm">üìÑ –ù–æ–≤—ã–π —Ñ–∞–π–ª</button>
            <button onclick="loadFiles()" class="btn btn-sm">üîÑ</button>
          </div>
        </div>
        <div class="file-list" id="fileList"></div>
      </div>
      <div id="fileEditor" class="file-editor hidden">
        <div class="editor-header">
          <span id="editorFilename"></span>
          <div>
            <button onclick="saveFile()" class="btn btn-primary btn-sm">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeEditor()" class="btn btn-sm">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <textarea id="editorContent"></textarea>
      </div>
    </div>

    <!-- Admin Tab -->
    <div id="adminTab" class="admin-panel hidden">
      <div class="admin-nav">
        <div class="admin-nav-item active" data-section="users" onclick="switchAdminSection('users')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        </div>
        <div class="admin-nav-item" data-section="server" onclick="switchAdminSection('server')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="8" rx="2"/><rect x="2" y="14" width="20" height="8" rx="2"/></svg>
          –°–µ—Ä–≤–µ—Ä
        </div>
      </div>
      <div class="admin-content">
        <div id="usersSection">
          <h2>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
          <div class="users-form">
            <input type="text" id="newUsername" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="newPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <label><input type="checkbox" id="newIsAdmin"> –ê–¥–º–∏–Ω</label>
            <button class="btn btn-primary" onclick="createUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          <div class="users-table-wrap">
            <table class="users-table">
              <thead><tr><th>–õ–æ–≥–∏–Ω</th><th>–†–æ–ª—å</th><th>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä</th><th>Proxy Key</th><th>–°–æ–∑–¥–∞–Ω</th><th></th></tr></thead>
              <tbody id="usersTableBody"></tbody>
            </table>
          </div>
        </div>
        <div id="serverSection" class="hidden">
          <h2>–°–µ—Ä–≤–µ—Ä</h2>
          <div class="server-stats" id="serverStats"></div>
          <h3 style="margin:16px 0 12px">–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã</h3>
          <div class="containers-list" id="containersList"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="sessionsModal" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <h3 id="modalTitle">–°–µ—Å—Å–∏–∏</h3>
      <div id="modalContent"></div>
      <button class="btn" style="margin-top:16px;width:100%" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="createSessionModal" class="modal-overlay hidden" onclick="if(event.target===this)closeCreateModal()">
    <div class="modal">
      <h3>–ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è</h3>
      <div class="modal-form-group">
        <label>–ò–º—è —Å–µ—Å—Å–∏–∏:</label>
        <input type="text" id="newSessionName" class="modal-input" placeholder="–ê–≥–µ–Ω—Ç 1">
      </div>
      <div class="modal-form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="startPi" checked>
          –ó–∞–ø—É—Å—Ç–∏—Ç—å pi
        </label>
      </div>
      <div class="modal-buttons">
        <button class="btn" onclick="closeCreateModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" onclick="confirmCreateSession()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script>
    let currentUser = null, authToken = localStorage.getItem("token"), sessions = [], activeSessionId = null;
    let terminal = null, fitAddon = null, ws = null;
    let currentPath = "/root", currentTab = "terminal", currentAdminSection = "users";
    let menuOpen = false;

    function toggleMenu() {
      menuOpen = !menuOpen;
      document.getElementById("mobileMenu").classList.toggle("open", menuOpen);
    }

    async function init() {
      try {
        const res = await fetch("/api/me");
        if (res.ok) { currentUser = await res.json(); showApp(); }
      } catch {}
    }

    function showApp() {
      document.getElementById("loginView").classList.add("hidden");
      document.getElementById("appView").classList.remove("hidden");
      document.getElementById("userInfo").innerHTML = `<span>${currentUser.username}</span><button class="btn btn-small" onclick="logout()">–í—ã–π—Ç–∏</button>`;
      if (!currentUser.isAdmin) document.querySelectorAll(".admin-only").forEach(el => el.classList.add("hidden"));
      const webUrl = `https://console.beebro.com/${currentUser.username}/`;
      const webLink = document.getElementById("webLink");
      webLink.href = webUrl;
      webLink.textContent = webUrl;
      initTerminal();
      loadSessions();
    }

    async function login() {
      const username = document.getElementById("loginUsername").value;
      const password = document.getElementById("loginPassword").value;
      const res = await fetch("/api/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, password }) });
      if (res.ok) { const data = await res.json(); currentUser = { username: data.username, isAdmin: data.isAdmin }; authToken = data.token; localStorage.setItem("token", data.token); showApp(); }
      else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
    }

    async function logout() { await fetch("/api/logout", { method: "POST" }); location.reload(); }

    function initTerminal() {
      terminal = new Terminal({ cursorBlink: true, fontSize: 14, fontFamily: "Menlo, Monaco, monospace", theme: { background: "#1e1e1e" } });
      fitAddon = new FitAddon.FitAddon();
      terminal.loadAddon(fitAddon);
      terminal.open(document.getElementById("terminalContainer"));
      setTimeout(() => fitAddon.fit(), 100);
      terminal.onData(data => { if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: "input", data })); });
      window.addEventListener("resize", () => { if (currentTab === "terminal") setTimeout(() => fitAddon.fit(), 100); });
    }

    async function loadSessions() {
      const res = await fetch("/api/sessions");
      sessions = await res.json();
      renderSessions();
      if (sessions.length && !activeSessionId) switchSession(sessions[0].id);
    }

    function renderSessions() {
      // Desktop list
      const list = document.getElementById("sessionsList");
      if (!sessions.length) { list.innerHTML = "<div class=\"no-sessions\">–ù–µ—Ç —Å–µ—Å—Å–∏–π</div>"; }
      else { list.innerHTML = sessions.map(s => `<div class="session-item ${s.id === activeSessionId ? "active" : ""}" onclick="switchSession('${s.id}')" ondblclick="event.stopPropagation();renameSession('${s.id}')"><span>${escapeHtml(s.name)}</span><button class="session-close" onclick="event.stopPropagation();deleteSession('${s.id}')">&times;</button></div>`).join(""); }
      
      // Mobile bar
      const bar = document.getElementById("sessionsBar");
      bar.innerHTML = sessions.map(s => `<div class="session-chip ${s.id === activeSessionId ? "active" : ""}" onclick="switchSession('${s.id}')" ondblclick="event.stopPropagation();renameSession('${s.id}')"><span>${escapeHtml(s.name)}</span><span class="close" onclick="event.stopPropagation();deleteSession('${s.id}')">&times;</span></div>`).join("") + `<button class="add-session-btn" onclick="createSession()">+ –ù–æ–≤–∞—è</button>`;
    }

    function createSession() {
      document.getElementById("newSessionName").value = "–ê–≥–µ–Ω—Ç " + (sessions.length + 1);
      document.getElementById("startPi").checked = true;
      document.getElementById("createSessionModal").classList.remove("hidden");
      setTimeout(() => document.getElementById("newSessionName").focus(), 100);
    }

    function closeCreateModal() {
      document.getElementById("createSessionModal").classList.add("hidden");
    }

    async function confirmCreateSession() {
      const name = document.getElementById("newSessionName").value.trim() || "–ê–≥–µ–Ω—Ç " + (sessions.length + 1);
      const startPi = document.getElementById("startPi").checked;
      closeCreateModal();
      const res = await fetch("/api/sessions", { method: "POST", headers: { "Content-Type": "application/json", "Authorization": "Bearer " + authToken }, body: JSON.stringify({ name, startPi }) });
      if (res.ok) { const sess = await res.json(); sessions.push(sess); switchSession(sess.id); }
    }

    async function renameSession(id) {
      const session = sessions.find(s => s.id === id);
      if (!session) return;
      const name = prompt("–ù–æ–≤–æ–µ –∏–º—è:", session.name);
      if (!name || name === session.name) return;
      const res = await fetch(`/api/sessions/${id}`, { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name }) });
      if (res.ok) { session.name = name; renderSessions(); }
    }

    async function deleteSession(id) {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é?")) return;
      await fetch(`/api/sessions/${id}`, { method: "DELETE" });
      sessions = sessions.filter(s => s.id !== id);
      if (activeSessionId === id) { activeSessionId = null; ws && ws.close(); terminal.clear(); setStatus(false); }
      renderSessions();
      if (sessions.length && !activeSessionId) switchSession(sessions[0].id);
    }

    function switchSession(id) {
      if (activeSessionId === id) return;
      ws && ws.close();
      activeSessionId = id;
      renderSessions();
      terminal.clear();
      const proto = location.protocol === "https:" ? "wss:" : "ws:";
      ws = new WebSocket(`${proto}//${location.host}/?session=${id}&token=${authToken || ""}`);
      ws.onopen = () => { setStatus(true); setTimeout(() => { fitAddon.fit(); terminal.focus(); ws.send(JSON.stringify({ type: "resize", cols: terminal.cols, rows: terminal.rows })); }, 100); };
      ws.onmessage = e => { if (e.data instanceof Blob) e.data.text().then(t => terminal.write(t)); else terminal.write(e.data); };
      ws.onclose = () => setStatus(false);
    }

    function setStatus(c) { document.getElementById("statusDot").className = "status-dot" + (c ? " connected" : ""); document.getElementById("statusText").textContent = c ? "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–û—Ç–∫–ª—é—á–µ–Ω–æ"; }

    function switchTab(tab) {
      currentTab = tab;
      // Desktop tabs
      document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
      // Mobile menu
      document.querySelectorAll(".mobile-menu-item").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
      
      document.getElementById("terminalTab").classList.toggle("hidden", tab !== "terminal");
      document.getElementById("filesTab").classList.toggle("hidden", tab !== "files");
      document.getElementById("adminTab").classList.toggle("hidden", tab !== "admin");
      
      if (tab === "terminal") setTimeout(() => { fitAddon && fitAddon.fit(); terminal && terminal.focus(); }, 100);
      if (tab === "files") loadFiles()
      if (tab === "admin") { loadUsers(); loadServerInfo(); }
    }

    function switchAdminSection(section) {
      currentAdminSection = section;
      document.querySelectorAll(".admin-nav-item").forEach(el => el.classList.toggle("active", el.dataset.section === section));
      document.getElementById("usersSection").classList.toggle("hidden", section !== "users");
      document.getElementById("serverSection").classList.toggle("hidden", section !== "server");
    }

    async function loadFiles() {
      document.getElementById("currentPath").textContent = currentPath;
      try {
        const res = await fetch(`/api/files?path=${encodeURIComponent(currentPath)}`, { headers: { Authorization: "Bearer " + authToken } });
        const data = await res.json(); const files = data.files || [];
        document.getElementById("fileList").innerHTML = files.map(f => `<div class="file-item" onclick="openFile('${escapeJs(f.name)}',${f.isDir})"><span class="file-icon">${f.isDir ? "üìÅ" : "üìÑ"}</span><div class="file-info"><div class="file-name">${escapeHtml(f.name)}</div><div class="file-meta">${f.size} B</div></div></div>`).join("");
      } catch { document.getElementById("fileList").innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>"; }
    }

    function openFile(name, isDir) { if (isDir) { currentPath = currentPath === "/" ? `/${name}` : `${currentPath}/${name}`; loadFiles(); } else { const ext = name.split(".").pop().toLowerCase(); const imageExts = ["png", "jpg", "jpeg", "gif", "webp", "svg", "ico", "bmp"]; if (imageExts.includes(ext)) { viewImage(name); } else { editFile(name); } } }
    function viewImage(name) {
      const path = currentPath === "/" ? `/${name}` : `${currentPath}/${name}`;
      const imgUrl = `/api/files/raw?path=${encodeURIComponent(path)}`;
      document.getElementById("fileEditor").classList.remove("hidden");
      document.getElementById("editorFilename").textContent = path;
      document.getElementById("editorContent").style.display = "none";
      let imgPreview = document.getElementById("imagePreview");
      if (!imgPreview) {
        imgPreview = document.createElement("img");
        imgPreview.id = "imagePreview";
        imgPreview.style.cssText = "max-width:100%;max-height:70vh;display:block;margin:10px auto";
        document.getElementById("editorContent").parentNode.insertBefore(imgPreview, document.getElementById("editorContent"));
      }
      imgPreview.src = imgUrl + "&token=" + authToken;
      imgPreview.style.display = "block";
      editingFilePath = path;
    }

    async function editFile(name) { const path = currentPath === "/" ? `/${name}` : `${currentPath}/${name}`; try { const res = await fetch(`/api/files/read?path=${encodeURIComponent(path)}`, { headers: { Authorization: "Bearer " + authToken } }); if (!res.ok) { alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª"); return; } const data = await res.json(); document.getElementById("fileEditor").classList.remove("hidden"); document.getElementById("editorFilename").textContent = path; document.getElementById("editorContent").value = data.content; editingFilePath = path; } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); } }
    async function saveFile() { try { const res = await fetch("/api/files/write", { method: "POST", headers: { "Content-Type": "application/json", Authorization: "Bearer " + authToken }, body: JSON.stringify({ path: editingFilePath, content: document.getElementById("editorContent").value }) }); if (res.ok) alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); else alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"); } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); } }
    function closeEditor() { document.getElementById("fileEditor").classList.add("hidden"); document.getElementById("editorContent").style.display = "block"; const imgPreview = document.getElementById("imagePreview"); if (imgPreview) imgPreview.style.display = "none"; editingFilePath = null; }
    let editingFilePath = null;
    function navigateUp() { if (currentPath !== "/") { currentPath = currentPath.split("/").slice(0, -1).join("/") || "/"; loadFiles(); } }
    async function createFolder() { const name = prompt("–ò–º—è –ø–∞–ø–∫–∏:"); if (!name) return; try { const res = await fetch("/api/files/mkdir", { method: "POST", headers: { "Content-Type": "application/json", Authorization: "Bearer " + authToken }, body: JSON.stringify({ path: currentPath === "/" ? `/${name}` : `${currentPath}/${name}` }) }); if (res.ok) loadFiles(); else alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏"); } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); } }
    async function createFile() { const name = prompt("–ò–º—è —Ñ–∞–π–ª–∞:"); if (!name) return; const path = currentPath === "/" ? `/${name}` : `${currentPath}/${name}`; try { const res = await fetch("/api/files/write", { method: "POST", headers: { "Content-Type": "application/json", Authorization: "Bearer " + authToken }, body: JSON.stringify({ path, content: "" }) }); if (res.ok) { loadFiles(); editFile(name); } else alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞"); } catch(e) { alert("–û—à–∏–±–∫–∞: " + e.message); } }

    async function loadUsers() {
      const res = await fetch("/api/users");
      const users = await res.json();
      document.getElementById("usersTableBody").innerHTML = users.map(u => `<tr><td>${escapeHtml(u.username)}</td><td><span class="badge ${u.isAdmin ? "badge-admin" : "badge-user"}">${u.isAdmin ? "–ê–¥–º–∏–Ω" : "–Æ–∑–µ—Ä"}</span></td><td>${escapeHtml(u.container) || "-"}</td><td style="font-family:monospace;font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(u.proxyKey) || ''}">${escapeHtml(u.proxyKey) || "-"}</td><td>${new Date(u.createdAt).toLocaleDateString()}</td><td>${u.username !== currentUser.username ? `<button class="btn btn-small btn-danger" onclick="deleteUser(${u.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ""}</td></tr>`).join("");
    }

    async function createUser() {
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const isAdmin = document.getElementById("newIsAdmin").checked;
      if (!username || !password) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
      const res = await fetch("/api/users", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, password, isAdmin }) });
      if (res.ok) { document.getElementById("newUsername").value = ""; document.getElementById("newPassword").value = ""; document.getElementById("newIsAdmin").checked = false; loadUsers(); }
      else { const err = await res.json(); alert(err.error); }
    }

    async function deleteUser(id) { if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return; await fetch(`/api/users/${id}`, { method: "DELETE" }); loadUsers(); }

    async function loadServerInfo() {
      try {
        const res = await fetch("/api/server/info");
        const info = await res.json();
        const memPct = Math.round(info.memory.used / info.memory.total * 100);
        const diskPct = Math.round(info.disk.used / info.disk.total * 100);
        document.getElementById("serverStats").innerHTML = `
          <div class="stat-card"><div class="stat-label">–ü–∞–º—è—Ç—å</div><div class="stat-value">${memPct}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${memPct}%"></div></div><div style="font-size:11px;color:#666;margin-top:4px">${formatBytes(info.memory.used)} / ${formatBytes(info.memory.total)}</div></div>
          <div class="stat-card"><div class="stat-label">CPU (${info.cpu.cores})</div><div class="stat-value">${info.cpu.load.toFixed(2)}</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${Math.min(info.cpu.load/info.cpu.cores*100,100)}%"></div></div></div>
          <div class="stat-card"><div class="stat-label">–î–∏—Å–∫</div><div class="stat-value">${diskPct}%</div><div class="stat-bar"><div class="stat-bar-fill" style="width:${diskPct}%"></div></div><div style="font-size:11px;color:#666;margin-top:4px">${formatBytes(info.disk.used)} / ${formatBytes(info.disk.total)}</div></div>
          <div class="stat-card"><div class="stat-label">–ê–ø—Ç–∞–π–º</div><div class="stat-value" style="font-size:14px">${info.uptime}</div></div>`;
      } catch {}
      try {
        const res = await fetch("/api/server/containers");
        const containers = await res.json();
        document.getElementById("containersList").innerHTML = containers.map(c => `<div class="container-item" data-name="${escapeHtml(c.name)}"><span class="container-status ${c.status.toLowerCase()}"></span><div class="container-info"><div class="container-name">${escapeHtml(c.name)}</div><div class="container-ip">${c.ip || "‚Äî"}</div><div class="container-size" id="size-${escapeHtml(c.name)}">‚è≥</div></div><button class="btn btn-small" onclick="showContainerSessions('${escapeHtml(c.name)}')">–°–µ—Å—Å–∏–∏</button></div>`).join("");
        // Load sizes async
        containers.forEach(async c => {
          try {
            const sizeRes = await fetch(`/api/server/containers/${escapeHtml(c.name)}/size`);
            const data = await sizeRes.json();
            const el = document.getElementById(`size-${escapeHtml(c.name)}`);
            if (el) el.textContent = formatBytes(data.size || 0);
          } catch {}
        });
      } catch {}
    }

    async function showContainerSessions(name) {
      document.getElementById("modalTitle").textContent = `–°–µ—Å—Å–∏–∏: ${name}`;
      try {
        const res = await fetch(`/api/server/containers/${name}/sessions`);
        const sess = await res.json();
        document.getElementById("modalContent").innerHTML = sess.length ? sess.map(s => `<div class="modal-session">${escapeHtml(s.name)}</div>`).join("") : "<p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</p>";
      } catch { document.getElementById("modalContent").innerHTML = "<p>–û—à–∏–±–∫–∞</p>"; }
      document.getElementById("sessionsModal").classList.remove("hidden");
    }

    function closeModal() { document.getElementById("sessionsModal").classList.add("hidden"); }
    function formatBytes(b) { if(b<1024)return b+" B";if(b<1048576)return(b/1024).toFixed(1)+" KB";if(b<1073741824)return(b/1048576).toFixed(1)+" MB";return(b/1073741824).toFixed(1)+" GB"; }
    function escapeHtml(str) { if (!str) return ''; const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
    function escapeJs(str) { if (!str) return ''; return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"'); }

    init();
  </script>
</body>
</html>
